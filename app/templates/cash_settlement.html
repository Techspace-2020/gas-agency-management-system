{% extends "base.html" %}

{% block title %}Expected Cash - Veena Indane{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <!-- <a href="{{ url_for('stock_day.dashboard') }}" class="btn btn-outline-secondary border-0 shadow-sm">
            <i class="bi bi-arrow-left-circle-fill me-1"></i> Dashboard
        </a> -->
        <h2 class="fw-bold mb-0 border-bottom border-dark pb-2">Step 5: Expected Cash Calculation</h2>
    </div>
    <span class="badge bg-dark fs-6">Stock Date: {{ stock_date }}</span>
</div>

{# Status Notifications #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}{% for category, message in messages %}
        <div class="alert alert-{{ category }} shadow-sm w-50 mb-4">{{ message }}</div>
    {% endfor %}{% endif %}
{% endwith %}

{% if is_updated %}
<div class="alert alert-info border-0 shadow-sm d-flex align-items-centermb-4 p-3">
    <i class="bi bi-lock-fill fs-5 me-2 text-primary"></i>
    <div>
        <strong>Finalized:</strong> Connection fees and TV-Out refunds are office-handled. Delivery boys are only responsible for refill cash.
    </div>
</div>
{% endif %}

{# --- Delivery Boy Section --- #}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-primary text-white py-3">
        <h5 class="text-center mb-0 fw-bold ps-6"><i class="bi bi-people-fill me-2"></i>Delivery Boys Refill Dues</h5>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th class="text-center ps-5 border-bottom border-dark" style="color: rgba(241, 76, 6, 0.884);">Delivery Boys</th>
                    <th class="text-center pe-4 border-bottom border-dark" style="color: rgba(241, 76, 6, 0.884);">Total Refill Amount to Deposit</th>
                </tr>
            </thead>
            <tbody>
                {% for row in staff_results %}
                <tr>
                    <td class="text-center ps-5 fw-bold text-dark">{{ row.delivery_boy }}</td>
                    <td class="text-center pe-4 fw-bold text-success">₹{{ "{:,.2f}".format(row.regular_amt | default(0)) }}</td>
                </tr>
                {% endfor %}
                {% if not staff_results %}
                <tr><td colspan="2" class="text-center py-3 text-muted">No staff deliveries recorded for today.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{# --- Office Summary Section --- #}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-dark text-white py-3">
        <h5 class="mb-0 fw-bold"><i class="bi bi-building-fill me-2"></i>Office Counter Summary</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-end">
                <thead class="table-light text-center">
                    <tr>
                        <th class="text-start">Category</th>
                        <th>NC Connections</th>
                        <th>DBC Connections</th>
                        <th class="text-danger">TV-Out Refunds</th>
                        <th class="bg-light">Net Connection Total</th>
                    </tr>
                </thead>
                <tbody>
                    {# Row 1: Global Connections (Staff) #}
                    <tr>
                        <td class="text-start">Global Transactions (All Staff)</td>
                        <td class="text-center">₹{{ "{:,.2f}".format(total_nc | default(0)) }}</td>
                        <td class="text-center">₹{{ "{:,.2f}".format(total_dbc | default(0)) }}</td>
                        <td class="text-danger text-center">- ₹{{ "{:,.2f}".format(total_tv | default(0)) }}</td>
                        <td class="fw-bold text-primary text-center">₹{{ "{:,.2f}".format(net_office_connection_cash | default(0)) }}</td>
                    </tr>
                    {# Row 2: Pure Office Sales (Refill + Counter NC/DBC) #}
                    <tr class="table-info">
                        <td class="text-start fw-bold">Office Counter Sales</td>
                        <td colspan="3" class="text-center text-muted small">Sales recorded directly at office window</td>
                        <td class="fw-bold text-center">₹{{ "{:,.2f}".format(pure_office_sales | default(0)) }}</td>
                    </tr>
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th colspan="4" class="text-start ps-4">GRAND TOTAL EXPECTED AT OFFICE COUNTER</th>
                        <th class="text-center pe-3 fs-5 text-dark">
                            {# This now displays the combined total calculated in Python (e.g., ₹11,207.00) #}
                            ₹{{ "{:,.2f}".format(office_expected | default(0)) }}
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="small text-muted mt-2 mb-0">
            <i class="bi bi-info-circle me-1"></i> Note: Expected amount combines pure counter sales and global staff connection fees.
        </p>
    </div>
</div>

{# --- Finalize Action --- #}
<div class="card-footer border-0 bg-transparent p-0">
    {% if not office_finalized %}
    <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4">
        <i class="bi bi-exclamation-triangle-fill fs-5 me-2"></i>
        <div><strong>Step 3 Not Complete:</strong> Please finalize Office Sales before locking cash records.</div>
    </div>
    {% endif %}

    <form method="POST" id="cash_settlement_form">
        <!-- USE THIS: It does NOT require a 'form' variable from Python -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if is_updated %}
            <button type="button" class="btn btn-secondary btn-lg px-5 fw-bold" disabled>
                <i class="bi bi-shield-check me-2"></i>CASH RECORDS FINALIZED
            </button>
        {% else %}
            <button type="button" id="confirmAllBtn" class="btn btn-primary btn-lg px-5 fw-bold shadow"
                    {% if not office_finalized %}disabled{% endif %}>
                <i class="bi bi-save me-2"></i>CONFIRM CASH RECORDS
            </button>
        {% endif %}
    </form>
</div>

<div class="d-flex justify-content-between mt-4">
    <a href="{{ url_for('stock_day.dashboard') }}" class="btn btn-outline-secondary px-4">
        <i class="bi bi-arrow-left me-2"></i>BACK
    </a>
</div>

<div class="modal fade" id="confirmAllModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Please confirm</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body py-4 text-center fs-5">
          Are you sure you want to finalize the expected cash records for today?<br>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" id="confirmAllYes" class="btn btn-primary px-4 fw-bold">Yes, Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var confirmBtn = document.getElementById('confirmAllBtn');
    var confirmModal = new bootstrap.Modal(document.getElementById('confirmAllModal'));
    var confirmYes = document.getElementById('confirmAllYes');
    var form = document.getElementById('cash_settlement_form');

    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            confirmModal.show();
        });
    }

    if (confirmYes) {
        confirmYes.addEventListener('click', function() {
            confirmYes.disabled = true;
            confirmYes.innerText = 'Confirming...';
            form.submit();
        });
    }

    const noMovCheck = document.getElementById('noMovCheck');
    if (noMovCheck) {
        noMovCheck.addEventListener('change', function() {
            const tableSection = document.getElementById('tableSection');
            const inputs = document.querySelectorAll('.iocl-input');
            if(this.checked) {
                tableSection.style.opacity = '0.5';
                tableSection.style.pointerEvents = 'none';
                inputs.forEach(input => input.value = 0);
            } else {
                tableSection.style.opacity = '1';
                tableSection.style.pointerEvents = 'auto';
            }
        });
    }
});
</script>
{% endblock %}